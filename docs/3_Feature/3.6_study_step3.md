# 3.6 Logic Bước 3: Game "Nhanh như chớp" (Speed Quiz)

## 1. Mô tả
Đây là bước cuối cùng (Gamification). Người dùng phải phản xạ nhanh (3 giây/từ). Nếu sai, từ đó sẽ bị đẩy xuống cuối hàng đợi để hỏi lại sau.

- **Component:** `src/components/StudyStep3.jsx`
- **Cơ chế chính:** Batch Processing (Xử lý theo lô) & Queue Re-insertion (Thêm lại vào hàng đợi).

## 2. Quản lý Trạng thái (Game State)
Do tính chất là Game thời gian thực, component này sử dụng nhiều biến state phức tạp.

| Tên State | Kiểu | Mô tả |
| :--- | :--- | :--- |
| `gameState` | String | Trạng thái màn hình: `'intro'` (Giới thiệu), `'playing'` (Đang chơi), `'batch_summary'` (Kết quả lô). |
| `queue` | Array | Hàng đợi chứa TẤT CẢ các từ cần hỏi. Ban đầu là danh sách từ được xáo trộn. |
| `currentBatch` | Array | Một lô nhỏ (tối đa 10 từ) được lấy từ `queue` để hỏi trong 1 lượt. |
| `wrongWordsInBatch`| Array | Danh sách các từ trả lời sai trong lô hiện tại (sẽ bị phạt thêm lại vào queue). |
| `timeLeft` | Number | Thời gian còn lại cho câu hỏi hiện tại (Mặc định: 3s). |
| `progressWidth` | Number | Độ rộng thanh hiển thị thời gian (100% -> 0%). |

## 3. Quy trình Xử lý (Logic Flow)

### A. Hệ thống "Hàng đợi & Lô" (Queue & Batch System)
Để tránh người dùng bị nản khi bài học quá dài, hệ thống chia nhỏ bài học:
1.  **Start Batch:** Lấy 10 từ đầu tiên từ `queue` đưa vào `currentBatch`.
2.  **Playing:** Người dùng chơi lần lượt 10 từ này.
3.  **End Batch:**
    - Nếu có từ sai (`wrongWordsInBatch > 0`): Đẩy các từ này vào ngược lại cuối hàng đợi `queue`.
    - Hiển thị bảng tổng kết.
4.  **Next Batch:** Lấy tiếp 10 từ từ `queue` (lúc này đã bao gồm cả các từ vừa bị phạt).
5.  **Finish:** Khi `queue` rỗng hoàn toàn -> Gọi `onComplete()`.

### B. Logic Tạo câu hỏi (`prepareQuestion`)
Mỗi khi chuyển sang từ mới:
1.  **Reset Timer:** Đặt `timeLeft` về 3, `progressWidth` về 100.
2.  **Tạo đáp án nhiễu (Distractors):**
    - Lấy danh sách toàn bộ từ trong bài.
    - Loại bỏ từ đúng (Target word).
    - Xáo trộn và lấy ngẫu nhiên 3 từ sai.
3.  **Trộn đáp án:** Trộn từ đúng và 3 từ sai thành mảng `options` (4 phần tử).
4.  **Kích hoạt thanh thời gian:** Sau 50ms, set `progressWidth` về 0 để kích hoạt CSS Transition chạy mượt trong 3 giây.

### C. Logic Xử lý Trả lời (`handleAnswer`)
Được gọi khi người dùng chọn đáp án HOẶC hết giờ (`timeLeft === 0`).
- **Input:** Object đáp án đã chọn (hoặc `null` nếu timeout).
- **Kiểm tra:**
  - Nếu Đúng: Không làm gì cả.
  - Nếu Sai/Timeout: Thêm từ hiện tại vào mảng `wrongWordsInBatch`.
- **UI:** Khóa các nút bấm (`isAnswered = true`), hiện màu Xanh (Đúng) / Đỏ (Sai), hiện nút "Next Que".

## 4. Giao diện & Hiệu ứng (UI/UX)
- **Mobile-First Layout:** Giao diện được giới hạn chiều rộng (`max-w-[400px]`) để mô phỏng màn hình điện thoại, giúp người dùng tập trung cao độ.
- **Thanh thời gian (Time Bar):**
  - Sử dụng CSS `transition: linear` để tạo hiệu ứng thanh tụt dần đều theo thời gian thực.
  - Khi hết giờ hoặc đã trả lời: tắt transition để thanh dừng lại hoặc đầy ngay lập tức.